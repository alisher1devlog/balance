generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MarketStatus {
  ACTIVE    // Ishlayapti (To'lov qilgan)
  INACTIVE  // Vaqtincha to'xtatilgan (O'zi o'chirgan)
  BLOCKED   // Biz bloklaganmiz (Qoida buzgani uchun)
  EXPIRED   // Obuna tugagan (Puli yo'q)
  PENDING   // Yangi, hali tasdiqlanmagan
}

enum Role {
  OWNER
  STAFF
}

enum UserStatus {
  ACTIVE    // Ishlayapti
  BLOCKED   // Bloklangan
  EXPIRED   // Obuna tugagan (Faqat Owner uchun)
}

enum TransactionType {
  DEBT      // Qarz berish
  PAYMENT   // To'lov qabul qilish
}



model SubscriptionPlan {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(50)     // "Start", "Pro"
  duration    Int      // Kun (30, 365)
  price       Decimal  @db.Decimal(15, 2)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  payments    Payment[]
  owners      User[]   // Bu tarifdan foydalanayotgan Ownerlar

  @@map("subscription_plans")
}

model Payment {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid // Kim to'ladi? (Owner)
  planId      String   @map("plan_id") @db.Uuid
  amount      Decimal  @db.Decimal(10, 2)
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User             @relation(fields: [userId], references: [id])
  plan        SubscriptionPlan @relation(fields: [planId], references: [id])

  @@map("payments")
}

model User {
  id           String      @id @default(uuid()) @db.Uuid
  // Agar STAFF bo'lsa, qaysi Marketda ishlashi shart. 
  // Agar OWNER bo'lsa, bu NULL bo'ladi (chunki uning marketlari ko'p).
  marketId     String?     @map("market_id") @db.Uuid 
  fullName     String      @map("full_name") @db.VarChar(100)
  phone        String?     @unique @db.VarChar(20)
  email        String?     @unique
  password     String     @db.VarChar(255)
  role         Role
  status       UserStatus  @default(ACTIVE)
  planId       String?     @map("plan_id") @db.Uuid // OBUNA (Faqat Owner uchun ishlatiladi)
  subEndDate   DateTime?   @map("sub_end_date") // Obuna tugash vaqti

  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  market       Market?     @relation("StaffMarket", fields: [marketId], references: [id]) // Staff bo'lsa
  plan         SubscriptionPlan? @relation(fields: [planId], references: [id])
  
  ownerMarkets Market[]    @relation("OwnerMarkets") // Ownerning shaxsiy marketlari
  payments     Payment[]
  transactions Transaction[]

  @@map("users")
}

model Market {
  id           String        @id @default(uuid()) @db.Uuid
  ownerId      String        @map("owner_id") @db.Uuid
  name         String        @db.VarChar(100) 
  address      String?        @db.VarChar(255) 

  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  
  owner        User          @relation("OwnerMarkets", fields: [ownerId], references: [id])
  staffs       User[]        @relation("StaffMarket") 
  
  customers    Customer[]
  transactions Transaction[]

  @@map("markets")
}

model Customer {
  id           String        @id @default(uuid()) @db.Uuid
  marketId     String        @map("market_id") @db.Uuid 
  fullName     String        @map("full_name") @db.VarChar(100)
  phone        String        @db.VarChar(20)
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  market       Market        @relation(fields: [marketId], references: [id])
  balance      Balance?
  transactions Transaction[]

  @@map("customers")
}

model Balance {
  id           String   @id @default(uuid()) @db.Uuid
  customerId   String   @unique @map("customer_id") @db.Uuid
  amount       Decimal  @default(0) @db.Decimal(15, 2)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  customer     Customer @relation(fields: [customerId], references: [id])

  @@map("balances")
}

model Transaction {
  id           String          @id @default(uuid()) @db.Uuid
  marketId     String          @map("market_id") @db.Uuid
  userId       String          @map("user_id") @db.Uuid // Kim bajardi (Staff yoki Owner)
  customerId   String          @map("customer_id") @db.Uuid
  type         TransactionType
  amount       Decimal         @db.Decimal(15, 2)
  description  String?         @db.Text
  createdAt    DateTime        @default(now()) @map("created_at")

  market       Market          @relation(fields: [marketId], references: [id])
  user         User            @relation(fields: [userId], references: [id])
  customer     Customer        @relation(fields: [customerId], references: [id])

  @@map("transactions")
}